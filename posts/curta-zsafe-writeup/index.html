<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Curta CTF ZSafe Write-up" /><meta property="og:locale" content="en" /><meta name="description" content="This is a write-up for the Curta CTF ZSafe challenge. I initially didn‚Äôt submit a solution due to personal time constraints and issues with foundry scripts that made it impossible to submit directly using them. Instead I committed to the solve on Twitter. I did end up submitting landing me on 3rd, while I technically committed to the solution online before jinseo.eth came in 2nd I think it‚Äôs not fair to claim that I was ‚Äútruly‚Äù 2nd as with CTFs actually submitting and debugging the final details of your solution is often half the battle." /><meta property="og:description" content="This is a write-up for the Curta CTF ZSafe challenge. I initially didn‚Äôt submit a solution due to personal time constraints and issues with foundry scripts that made it impossible to submit directly using them. Instead I committed to the solve on Twitter. I did end up submitting landing me on 3rd, while I technically committed to the solution online before jinseo.eth came in 2nd I think it‚Äôs not fair to claim that I was ‚Äútruly‚Äù 2nd as with CTFs actually submitting and debugging the final details of your solution is often half the battle." /><link rel="canonical" href="https://philogy.github.io/posts/curta-zsafe-writeup/" /><meta property="og:url" content="https://philogy.github.io/posts/curta-zsafe-writeup/" /><meta property="og:site_name" content="Philogy‚Äôs blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2024-01-18T10:07:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Curta CTF ZSafe Write-up" /><meta name="twitter:site" content="@real_philogy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-01-21T16:09:24+01:00","datePublished":"2024-01-18T10:07:00+01:00","description":"This is a write-up for the Curta CTF ZSafe challenge. I initially didn‚Äôt submit a solution due to personal time constraints and issues with foundry scripts that made it impossible to submit directly using them. Instead I committed to the solve on Twitter. I did end up submitting landing me on 3rd, while I technically committed to the solution online before jinseo.eth came in 2nd I think it‚Äôs not fair to claim that I was ‚Äútruly‚Äù 2nd as with CTFs actually submitting and debugging the final details of your solution is often half the battle.","headline":"Curta CTF ZSafe Write-up","mainEntityOfPage":{"@type":"WebPage","@id":"https://philogy.github.io/posts/curta-zsafe-writeup/"},"url":"https://philogy.github.io/posts/curta-zsafe-writeup/"}</script><title>Curta CTF ZSafe Write-up | Philogy's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Philogy's blog"><meta name="application-name" content="Philogy's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/bootstrap-4.6.1/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free-5.15.4/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup-1.1.0/magnific-popup.css"> <script src="/assets/lib/jquery-3.6.0/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/headshot.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Philogy's blog</a></div><div class="site-subtitle font-italic">Phil's ideas & research.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Philogy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/real_philogy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['philippe','dumo.net'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Curta CTF ZSafe Write-up</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Curta CTF ZSafe Write-up</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1705568820" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 18, 2024 </em> </span> <span> Updated <em class="" data-ts="1705849764" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 21, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="/about">Philippe Dumonet</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2363 words"> <em>13 min</em> read</span></div></div></div><div class="post-content"><p>This is a write-up for the Curta CTF <a href="https://www.curta.wtf/puzzle/base:5">ZSafe</a> challenge. I initially didn‚Äôt submit a solution due to personal time constraints and <a href="https://github.com/foundry-rs/foundry/issues/6825">issues with foundry scripts</a> that made it impossible to submit directly using them. Instead I committed to the solve on <a href="https://x.com/real_philogy/status/1747381887679484166">Twitter</a>. I did end up submitting landing me on <a href="https://www.curta.wtf/puzzle/base:5/leaderboard">3rd</a>, while I technically committed to the solution online before jinseo.eth came in 2nd I think it‚Äôs not fair to claim that I was ‚Äútruly‚Äù 2nd as with CTFs actually submitting and debugging the final details of your solution is often half the battle.</p><p>You can see my full solution in my repo <a href="https://github.com/Philogy/curta-zsafe-solution">here</a>.</p><h2 id="intro"><span class="mr-2">Intro</span><a href="#intro" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The end goal is to have the <code class="language-plaintext highlighter-rouge">SafeCurta</code> puzzle contract‚Äôs <code class="language-plaintext highlighter-rouge">verify</code> function evaluate <code class="language-plaintext highlighter-rouge">true</code> for your seed which is determined by <code class="language-plaintext highlighter-rouge">generate</code>. To do so it checks that your associated <code class="language-plaintext highlighter-rouge">SafeChallenge</code> factory contract returns <code class="language-plaintext highlighter-rouge">isUnlocked</code>.</p><p><img data-src="/assets/images/zSafe-challenge-structure.png" alt="ZSafe Challenge Structure" data-proofer-ignore></p><p>Our setup is:</p><ol><li>Deploy the <code class="language-plaintext highlighter-rouge">SafeChallenge</code> contract<li>Find a way to pass the checks in its <code class="language-plaintext highlighter-rouge">unlock</code> function to achieved the <code class="language-plaintext highlighter-rouge">isUnlocked: true</code> state.</ol><p>To unlock the <code class="language-plaintext highlighter-rouge">SafeChallenge</code> contract (referred to as the lock from here on out) we must pass the <code class="language-plaintext highlighter-rouge">unlock</code> method 3 <code class="language-plaintext highlighter-rouge">r</code> values and 3 <code class="language-plaintext highlighter-rouge">s</code> values that when combined with the values of the <code class="language-plaintext highlighter-rouge">proxy</code> contract gives us 6 valid signatures for the set <code class="language-plaintext highlighter-rouge">owner</code>:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">unlock</span><span class="p">(</span><span class="kt">bytes32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">calldata</span> <span class="n">r</span><span class="p">,</span> <span class="kt">bytes32</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="k">calldata</span> <span class="n">s</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
    <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">&lt;</span> <span class="kt">uint256</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]));</span>
    <span class="p">}</span>

    <span class="k">for</span> <span class="p">(</span><span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">check</span><span class="p">(</span><span class="n">r</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="p">}</span>

    <span class="n">isUnlocked</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">check</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">_r</span><span class="p">,</span> <span class="kt">bytes32</span> <span class="n">_s</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
    <span class="kt">uint8</span> <span class="n">v</span> <span class="o">=</span> <span class="mi">27</span><span class="p">;</span>

    <span class="kt">address</span> <span class="n">owner</span> <span class="o">=</span> <span class="n">proxy</span><span class="p">.</span><span class="n">owner</span><span class="p">();</span>

    <span class="kt">bytes32</span> <span class="n">message1_hash</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0xdead</span><span class="p">)));</span>
    <span class="kt">bytes32</span> <span class="n">r1</span> <span class="o">=</span> <span class="n">transform_r1</span><span class="p">(</span><span class="n">_r</span><span class="p">);</span>
    <span class="kt">bytes32</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">transform_s1</span><span class="p">(</span><span class="n">_s</span><span class="p">);</span>
    <span class="kt">address</span> <span class="n">signer</span> <span class="o">=</span> <span class="nb">ecrecover</span><span class="p">(</span><span class="n">message1_hash</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">r1</span><span class="p">,</span> <span class="n">s1</span><span class="p">);</span>

    <span class="nb">require</span><span class="p">(</span><span class="n">signer</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">"no sig match :&lt;"</span><span class="p">);</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">signer</span> <span class="o">==</span> <span class="n">owner</span><span class="p">,</span> <span class="s">"no owner match :&lt;"</span><span class="p">);</span>

    <span class="kt">bytes32</span> <span class="n">message2_hash</span> <span class="o">=</span> <span class="nb">keccak256</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="n">seed</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="mh">0xbeef</span><span class="p">)));</span>
    <span class="kt">bytes32</span> <span class="n">r2</span> <span class="o">=</span> <span class="n">transform_r2</span><span class="p">(</span><span class="n">_r</span><span class="p">);</span>
    <span class="kt">bytes32</span> <span class="n">s2</span> <span class="o">=</span> <span class="n">transform_s2</span><span class="p">(</span><span class="n">_s</span><span class="p">);</span>
    <span class="kt">address</span> <span class="n">signer2</span> <span class="o">=</span> <span class="nb">ecrecover</span><span class="p">(</span><span class="n">message2_hash</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">r2</span><span class="p">,</span> <span class="n">s2</span><span class="p">);</span>

    <span class="nb">require</span><span class="p">(</span><span class="n">signer2</span> <span class="o">!=</span> <span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="s">"no sig match :&lt;"</span><span class="p">);</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">signer2</span> <span class="o">==</span> <span class="n">owner</span><span class="p">,</span> <span class="s">"no owner match :&lt;"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We quickly realize that this is impossible. As defined in the whitelisted <code class="language-plaintext highlighter-rouge">SafeSecret</code> and <code class="language-plaintext highlighter-rouge">SafeSecretAdmin</code> contracts, they do not give us enough freedom with the return values to be able to create valid signatures. This is mainly because of the lock‚Äôs <code class="language-plaintext highlighter-rouge">transform_s2</code> method which derives the $s$ value for the second signature of every <code class="language-plaintext highlighter-rouge">check</code>:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">transform_s2</span><span class="p">(</span><span class="kt">bytes32</span> <span class="n">s</span><span class="p">)</span> <span class="k">internal</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bytes32</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="nb">keccak256</span><span class="p">(</span><span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="kt">uint256</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">^</span> <span class="n">proxy</span><span class="p">.</span><span class="n">p2</span><span class="p">(),</span> <span class="n">seed</span><span class="p">));</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The fact that it derives the second $s$ value from a hash means that we cannot reverse some useful final $s$ value to see what <code class="language-plaintext highlighter-rouge">p2()</code> value <code class="language-plaintext highlighter-rouge">SafeSecretAdmin</code> would need to return. Our only path is to choose some random <code class="language-plaintext highlighter-rouge">p2()</code> see what hash it results in and try to reverse the other values, but this is mathematically impossible without breaking the keccak hash function or dlog (fundamental cryptographic hardness assumption related to ECDSA).</p><p>So our only path forward is to somehow manipulate the <code class="language-plaintext highlighter-rouge">proxy</code> with a custom implementation such that <code class="language-plaintext highlighter-rouge">p2()</code> returns 2 separate values per <code class="language-plaintext highlighter-rouge">check</code>.</p><h2 id="part-1-bypassing-the-upgrade-whitelist"><span class="mr-2">Part 1: Bypassing the upgrade whitelist.</span><a href="#part-1-bypassing-the-upgrade-whitelist" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>To be able to manipulate how the proxy returns values for the <code class="language-plaintext highlighter-rouge">check</code> function you need to upgrade the proxy to code we control. However the whitelist only lets us change the implementation to a contract matching the code hash of the <code class="language-plaintext highlighter-rouge">SafeSecret</code> or <code class="language-plaintext highlighter-rouge">SafeSecretAdmin</code> contracts. However once the address is set the code is never revalidated, meaning if we are somehow able to change the code of a deployed contract in-place we can just upgrade the <code class="language-plaintext highlighter-rouge">proxy</code> to some ‚Äúvalid‚Äù code, change it and voila we have our malicious proxy implementation.</p><p>This can be achieved with the metamorphic contract pattern. Summarized what it does is deploy a contract using create2 such that the address of the contract is independent of its final runtime bytecode, instead it retrieves/builds its final bytecode in the constructor by using external information. By combining this with <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code> we can wipe the code and then redeploy different code <em>to the same address</em>:</p><div file="ReinitFactory.sol" class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="ReinitFactory.sol"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="k">contract</span> <span class="n">ReinitFactory</span> <span class="k">is</span> <span class="n">IReinitFactory</span> <span class="p">{</span>
    <span class="kt">bool</span> <span class="k">private</span> <span class="n">_copy</span><span class="p">;</span>
    <span class="kt">address</span> <span class="k">private</span> <span class="n">_target</span><span class="p">;</span>

    <span class="k">function</span> <span class="n">fakeDeploy</span><span class="p">(</span><span class="kt">address</span> <span class="n">target</span><span class="p">,</span> <span class="kt">address</span> <span class="n">victim</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">address</span> <span class="n">upgrade</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">_copy</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
        <span class="n">_target</span> <span class="o">=</span> <span class="n">target</span><span class="p">;</span>
        <span class="n">upgrade</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="k">new</span> <span class="n">FakeUpgrade</span><span class="p">{</span><span class="n">salt</span><span class="o">:</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">)}());</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">deployActual</span><span class="p">(</span><span class="kt">address</span> <span class="n">real</span><span class="p">,</span> <span class="kt">address</span> <span class="n">victim</span><span class="p">)</span> <span class="k">external</span> <span class="p">{</span>
        <span class="n">_copy</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
        <span class="n">_target</span> <span class="o">=</span> <span class="n">real</span><span class="p">;</span>
        <span class="k">new</span> <span class="n">FakeUpgrade</span><span class="p">{</span><span class="n">salt</span><span class="o">:</span> <span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">)}();</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="n">mode</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">override</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">,</span> <span class="kt">address</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">_copy</span><span class="p">,</span> <span class="n">_target</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><div file="FakeUpgrade.sol" class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="FakeUpgrade.sol"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="k">contract</span> <span class="n">FakeUpgrade</span> <span class="p">{</span>
    <span class="n">error</span> <span class="n">SetFailed</span><span class="p">();</span>

    <span class="k">constructor</span><span class="p">()</span> <span class="p">{</span>
        <span class="p">(</span><span class="kt">bool</span> <span class="n">copy</span><span class="p">,</span> <span class="kt">address</span> <span class="n">target</span><span class="p">)</span> <span class="o">=</span> <span class="n">IReinitFactory</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">).</span><span class="n">mode</span><span class="p">();</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">copy</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">assembly</span> <span class="p">{</span>
                <span class="kr">let</span> <span class="n">size</span> <span class="o">:=</span> <span class="n">extcodesize</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
                <span class="n">extcodecopy</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
                <span class="k">return</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
            <span class="p">}</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="c1">// Create minimal proxy bytecode.
</span>            <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">code</span> <span class="o">=</span>
                <span class="n">abi</span><span class="p">.</span><span class="n">encodePacked</span><span class="p">(</span><span class="s">hex"3d3d3d3d363d3d37363d73"</span><span class="p">,</span> <span class="kt">address</span><span class="p">(</span><span class="n">target</span><span class="p">),</span> <span class="s">hex"5af43d3d93803e602a57fd5bf3"</span><span class="p">);</span>

            <span class="k">assembly</span> <span class="p">{</span>
                <span class="k">return</span><span class="p">(</span><span class="n">add</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">),</span> <span class="n">mload</span><span class="p">(</span><span class="n">code</span><span class="p">))</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>So we can now use these contracts to deploy a contract that initially has a matching codehash to one on the whitelist. Note that for the branch where we insert our actual bytecode I only deploy a minimal proxy pointing to the actual code. While this adds some indirection it saves me a lot of gas when deploying the solution as I only have to deploy my final solution bytecode once instead of twice.</p><h2 id="part-2-self-destructing-the-impostor"><span class="mr-2">Part 2: Self-destructing the Impostor</span><a href="#part-2-self-destructing-the-impostor" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we‚Äôve deployed our own contract with the identical bytecode and upgraded to it we need to actually trigger a self-destruct, however, the code we‚Äôve copied doesn‚Äôt have one. We can still self-destruct, we‚Äôll just need to do so in another context. Specifically within a DELEGATECALL. Notice that the <code class="language-plaintext highlighter-rouge">upgradeToAndCall</code> function in <code class="language-plaintext highlighter-rouge">SafeUpgradeable</code> allows us to not only set the implementation but make an ‚Äúinitializing call‚Äù if:</p><ol><li>The new implementation is whitelisted<li>You pass the <code class="language-plaintext highlighter-rouge">onlyProxy</code> check</ol><p>(code slightly simplified from actual CTF)</p><div file="SafeUpgradeable.sol" class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="SafeUpgradeable.sol"><i class="far fa-file-code"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">upgradeToAndCall</span><span class="p">(</span><span class="kt">address</span> <span class="n">newImplementation</span><span class="p">,</span> <span class="kt">bytes</span> <span class="k">memory</span> <span class="n">data</span><span class="p">)</span> <span class="k">public</span> <span class="k">payable</span> <span class="k">virtual</span> <span class="n">onlyProxy</span> <span class="p">{</span>
    <span class="n">_authorizeUpgrade</span><span class="p">(</span><span class="n">newImplementation</span><span class="p">);</span>
    <span class="n">ERC1967Utils</span><span class="p">.</span><span class="n">upgradeToAndCall</span><span class="p">(</span><span class="n">newImplementation</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">_authorizeUpgrade</span><span class="p">(</span><span class="kt">address</span> <span class="n">newImplementation</span><span class="p">)</span> <span class="k">internal</span> <span class="p">{</span>
    <span class="nb">require</span><span class="p">(</span><span class="n">whitelist</span><span class="p">[</span><span class="n">newImplementation</span><span class="p">.</span><span class="n">codehash</span><span class="p">],</span> <span class="s">"wtf no whitelisted no hacc pls"</span><span class="p">);</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The first is easy to do, to be allowed to DELEGATECALL into an arbitrary contract we can simply whitelist it by calling the <code class="language-plaintext highlighter-rouge">initialize</code> method. For the second let‚Äôs look at the <code class="language-plaintext highlighter-rouge">_checkProxy</code> method underlying the modifier:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">_checkProxy</span><span class="p">()</span> <span class="k">internal</span> <span class="k">view</span> <span class="k">virtual</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">)</span> <span class="o">==</span> <span class="n">__self</span> <span class="o">||</span> <span class="n">ERC1967Utils</span><span class="p">.</span><span class="n">getImplementation</span><span class="p">()</span> <span class="o">!=</span> <span class="n">__self</span><span class="p">)</span> <span class="p">{</span>
        <span class="nb">revert</span><span class="p">(</span><span class="s">"No hacc"</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>We need to pass two checks:</p><p>a) That the contract‚Äôs address is <strong>not</strong> <code class="language-plaintext highlighter-rouge">__self</code> b) The set proxy implementation <strong>is</strong> <code class="language-plaintext highlighter-rouge">__self</code></p><p>Well, what is <code class="language-plaintext highlighter-rouge">__self</code>?</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kt">address</span> <span class="k">private</span> <span class="kr">immutable</span> <span class="n">__self</span> <span class="o">=</span> <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">);</span>
</pre></table></code></div></div><p>Well <code class="language-plaintext highlighter-rouge">__self</code> is an immutably stored variable containing <code class="language-plaintext highlighter-rouge">address(this)</code>. Immutables are stored as part of the bytecode and set at initialization meaning you can‚Äôt change them without affecting the code hash. When we copy the code for our imposter upgrade we copy the <em>original</em> address, meaning we implicitly pass the first check as our new contract‚Äôs address is by definition not the previous one.</p><p>For the second check we can‚Äôt directly set the implementation without doing an upgrade, this is a circular dependency. As the code stands we can‚Äôt pass it. However notice that the code hash only encapsulates the <em>runtime bytecode</em>, not the deployment bytecode. Meaning that we just have to set the implementation in the deploy code for our imposter contract.</p><p>With all the hurdles passed we trigger an upgrade, <code class="language-plaintext highlighter-rouge">DELEGATECALL</code>-ing to a contract that self-destructs on our behalf. Assuming we‚Äôve set up the factory and create2 deployment correctly we can then re-deploy any code we‚Äôd like to the address that‚Äôs now the implementation of the <code class="language-plaintext highlighter-rouge">SafeChallenge.proxy</code> contract:</p><p><img data-src="/assets/images/zSafe-malicious-upgrade.excalidraw.png" alt="Visualization of Malicious Upgrade Procedure" data-proofer-ignore></p><h2 id="part-3-passing-the-check-itself"><span class="mr-2">Part 3: Passing the check itself</span><a href="#part-3-passing-the-check-itself" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Now that we‚Äôre able to actually fully control the target bytecode we need to actually create signature values that‚Äôll pass the 3 calls to <code class="language-plaintext highlighter-rouge">check</code> in the lock (<code class="language-plaintext highlighter-rouge">SafeChallenge</code>) contract.</p><p>To reach the desired unlocked state we need to provide inputs into the <code class="language-plaintext highlighter-rouge">unlock</code> function such that the validation passes. The <code class="language-plaintext highlighter-rouge">unlock</code> function runs the <code class="language-plaintext highlighter-rouge">check</code> function 3 separate times on 3 pairs of inputs that we can provide. It also calls the proxy‚Äôs p1 and p2 methods for extra information, data that we can now control with our implanted implementation.</p><p>We need all the inputs to result in 2 separate signatures $(v, r, s)$ for 2 distinct messages. Assuming keccak isn‚Äôt broken these are guaranteed to be different due to their differing salt (<code class="language-plaintext highlighter-rouge">0xdead</code> and <code class="language-plaintext highlighter-rouge">0xbeef</code> respectively). Furthermore, the owner is only queried once and cannot change. The contract checks that <em>both</em> signatures were made by the same address and therefore the same key.</p><p>The neat thing about controlling the proxy however is that we can modify our <code class="language-plaintext highlighter-rouge">owner()</code>, <code class="language-plaintext highlighter-rouge">p1()</code> and <code class="language-plaintext highlighter-rouge">p2()</code> methods such that they return <em>different</em> values for every call of <code class="language-plaintext highlighter-rouge">check</code> despite being view functions. The <code class="language-plaintext highlighter-rouge">p2()</code> method is also called two separate times to derive the s value for the first and second signature meaning we can provide up to 6 different values via <code class="language-plaintext highlighter-rouge">p2()</code>.</p><p>As initially introduced, the second signature in <code class="language-plaintext highlighter-rouge">check</code> poses an issue, <code class="language-plaintext highlighter-rouge">transform_s2</code> derives the $s$ value of the second signature via the keccak hash function. Cryptographic hash functions are impossible to reverse (that we know of) so the second signature at least can‚Äôt be one that was generated <em>from</em> a private key. However, we don‚Äôt need it to be. Thanks to the math underyling ECDSA we can reverse the equation to compute the private key from a final signature, reversing the process.</p><p>The ECDSA signature generation algorithm is defined as follows (minus some checks):</p><ol><li>Pick a random $k \in [1, n-1]$.<li>Compute the coordinates $(x, y)$ of the point $K = k\cdot G$<li>Set the $r = x$<li>Compute $s = k^{-1} \cdot (z - r \cdot d_A)$ (where $z$ is our message hash and $d_A$ our private key)</ol><p>We can retrieve the private key to generate a valid signature for a given s by reversing the last equation:</p>\[s = k^{-1} \cdot (z - r \cdot d_A)\] \[d_A = (s \cdot k - z) \cdot r^{-1}\]<blockquote class="prompt-info"><div><p>The reason you can‚Äôt normally reverse an ECDSA signature to retrieve the original private key is because the underlying $k$ parameter is not meant to be known. If you have a cryptographic library that somehow leaks or reuses $k$ it allows you to extract the private keys that created signatures using it. In our situation since we control the process, we can choose and therefore know $k$.</p></div></blockquote><p>For our second signature, we can simply pick a random $k$ and <code class="language-plaintext highlighter-rouge">p2()</code> (denoted as $p_{2,2}$), hash $p_{2,2}$ to get $s_2$, compute $r$ from $k$ and get the private key using the above derivation. Now we simply sign the first hash using the derived private key and voila we have two distinct signatures $(v, r_1, s_1)$ and $(v, r_2, s_2)$ with $s_2$ being the result of a hash.</p><p>We now just compute $p_1$ for each check such that $r_2 = r_1 + p_1$ ($p_1 = r_2 - r_1 \mod 2^{256}$) and configure <code class="language-plaintext highlighter-rouge">p2()</code> to return $s_1$ then the original $p_{2,2}$ we used to compute $s_2$. We can set the externally supplied <code class="language-plaintext highlighter-rouge">s</code> values to 0 so that it does not affect the output of <code class="language-plaintext highlighter-rouge">p2()</code> when XOR-ed in <code class="language-plaintext highlighter-rouge">transform_s1</code> and <code class="language-plaintext highlighter-rouge">transform_s2</code>.</p><p>One last final issue is that the lock contract sees the proxies <code class="language-plaintext highlighter-rouge">p1()</code>, <code class="language-plaintext highlighter-rouge">p2()</code> and <code class="language-plaintext highlighter-rouge">owner()</code> methods as view-functions, meaning solc will compile the contract down to use <code class="language-plaintext highlighter-rouge">STATICCALL</code> to call the methods. This means we cannot modify in our methods. Without having access between the calls (which we do not), how do we make these functions stateful such that they ‚Äúknow‚Äù how often they were called so that they can return different values each time?</p><p>One way would be to set and check for a hardcoded gas remaining value, as gas will be used throughout the call and different amounts will be remaining. However trying to plan for and deal with specific gas uses is very finicky and I would not recommend such an approach.</p><p>Instead we can make these view methods stateful by taking advantage of the EVM‚Äôs storage cold/warm gas accounting. When a storage value is first read as part of a transaction it incurs a larger ‚Äúwarming‚Äù cost of 2100 to account for the node‚Äôs cost of fetching the value from its DB on disk, every subsequent time the value is <code class="language-plaintext highlighter-rouge">SLOAD</code>ed however, it only incurs a cost of 100 gas as it‚Äôs already ‚Äúwarm‚Äù and cached locally for the duration of the transaction. This means we can use the gas cost of loading variables to determine whether they‚Äôve been read already, giving us a stateful but <code class="language-plaintext highlighter-rouge">STATICCALL</code>-compatible way to return different values:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">p2</span><span class="p">()</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kr">unchecked</span> <span class="p">{</span>
        <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
            <span class="kt">uint256</span> <span class="n">preGas</span> <span class="o">=</span> <span class="nb">gasleft</span><span class="p">();</span>
            <span class="kt">uint256</span> <span class="n">p</span> <span class="o">=</span> <span class="n">p2s</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
            <span class="kt">uint256</span> <span class="n">afterGas</span> <span class="o">=</span> <span class="nb">gasleft</span><span class="p">();</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">preGas</span> <span class="o">-</span> <span class="n">afterGas</span> <span class="o">&gt;</span> <span class="mi">2100</span><span class="p">)</span> <span class="k">return</span> <span class="n">p</span><span class="p">;</span>

            <span class="n">i</span><span class="o">++</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">revert</span><span class="p">();</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Voila! Solved. We then simply stitch together the deployment and submission of our different transactions, test against a local fork before deploying on-chain. (Or in my case, accidentally deploy directly to mainnet, test locally before finally redeploying the fixed solution to mainnet).</p><h2 id="conclusion"><span class="mr-2">Conclusion</span><a href="#conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>Overall this was a very interesting challenge by <a href="https://twitter.com/ret2jazzy">Zellic‚Äôs jazzy</a>, taking advantage of some interesting math behind ECDSA and some false assumptions people commonly make about the immutability of code. Highly recommend you try it out, feel free to check out the code to my solution <a href="https://github.com/Philogy/curta-zsafe-solution">on github</a> as well. It contains not only the challenge and solution contracts but the python script I used to actually run the above math and generate the different values.</p><p>Feel free provide feedback on this post on <a href="https://twitter.com/real_philogy">Twitter (X)</a> or simply follow for more smart contract development and CTF content in the future! üòÅ</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf-writeups/'>ctf-writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/solidity/" class="post-tag no-text-decoration" >solidity</a> <a href="/tags/evm/" class="post-tag no-text-decoration" >EVM</a> <a href="/tags/smart-contracts/" class="post-tag no-text-decoration" >smart contracts</a> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Curta+CTF+ZSafe+Write-up+-+Philogy%27s+blog&url=https%3A%2F%2Fphilogy.github.io%2Fposts%2Fcurta-zsafe-writeup%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fphilogy.github.io%2Fposts%2Fcurta-zsafe-writeup%2F&text=Curta+CTF+ZSafe+Write-up+-+Philogy%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/curta-zsafe-writeup/">Curta CTF ZSafe Write-up</a><li><a href="/posts/paradigm-ctf-2022-write-up-collection/">Paradigm CTF 2022: Write-Up Collection</a><li><a href="/posts/quitting-dereg/">Quitting DeReg And What's Next</a><li><a href="/posts/defi-accounting-for-noobs/">Beancount: DeFi Accounting For Noobs</a><li><a href="/posts/selector-switches/">Constant Gas Function Dispatchers in the EVM</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/evm/">EVM</a> <a class="post-tag" href="/tags/smart-contracts/">smart contracts</a> <a class="post-tag" href="/tags/solidity/">solidity</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/accounting/">accounting</a> <a class="post-tag" href="/tags/beancount/">beancount</a> <a class="post-tag" href="/tags/defi/">DeFi</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/personal/">personal</a></div></div></div><script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/paradigm-ctf-2022-write-up-collection/"><div class="card-body"> <em class="small" data-ts="1661164560" data-df="ll" > Aug 22, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Paradigm CTF 2022: Write-Up Collection</h3><div class="text-muted small"><p> Intro I participated in the Paradigm CTF 2022 where I was personally able to solve 7 out of the 13 EVM-related challenges (not counting the PVP game 0xMonaco and external underhanded solidity conte...</p></div></div></a></div><div class="card"> <a href="/posts/selector-switches/"><div class="card-body"> <em class="small" data-ts="1647453300" data-df="ll" > Mar 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Constant Gas Function Dispatchers in the EVM</h3><div class="text-muted small"><p> Image: Telecom switchboard operator1 Intro Every2 smart contract on Ethereum and other EVM chains starts with its function dispatcher. Function dispatchers tell the contract whether they‚Äôve imple...</p></div></div></a></div><div class="card"> <a href="/posts/quitting-dereg/"><div class="card-body"> <em class="small" data-ts="1700845080" data-df="ll" > Nov 24, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quitting DeReg And What's Next</h3><div class="text-muted small"><p> Introduction For just over a year now I‚Äôve been working on a startup called ‚ÄúDeReg‚Äù, mostly full-time together with my amazing brother &amp;amp; co-founder Dimitri. Recently we have decided to stop th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/quitting-dereg/" class="btn btn-outline-primary" prompt="Older"><p>Quitting DeReg And What's Next</p></a><div class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></div></div></div></div><footer class="pl-3 pr-3"><div class="row d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="col-6 footer-left width-full"><p class="mb-0"> ¬© 2026 <a href="/about">Philippe Dumonet</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="col-6 footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/evm/">EVM</a> <a class="post-tag" href="/tags/smart-contracts/">smart contracts</a> <a class="post-tag" href="/tags/solidity/">solidity</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/accounting/">accounting</a> <a class="post-tag" href="/tags/beancount/">beancount</a> <a class="post-tag" href="/tags/defi/">DeFi</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/personal/">personal</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="/assets/lib/simple-jekyll-search-1.10.0/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="/assets/lib/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/lozad-1.16.0/lozad.min.js"></script> <script src="/assets/lib/clipboard-2.0.9/clipboard.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/dayjs.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/locale/en.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script> /* see: <https://docs.mathjax.org/en/latest/options/input/tex.html#tex-options> */ MathJax = { tex: { inlineMath: [ /* start/end delimiter pairs for in-line math */ ['$','$'], ['\\(','\\)'] ], displayMath: [ /* start/end delimiter pairs for display math */ ['$$', '$$'], ['\\[', '\\]'] ] } }; </script> <script src="/assets/lib/polyfill-v3-es6/polyfill.min.js"></script> <script id="MathJax-script" async src="/assets/lib/mathjax-3.2.0/tex-chtml.js"> </script> <script src="/assets/lib/bootstrap-4.6.1/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
