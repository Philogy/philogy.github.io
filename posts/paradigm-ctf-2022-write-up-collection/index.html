<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Paradigm CTF 2022: Write-Up Collection" /><meta property="og:locale" content="en" /><meta name="description" content="Intro I participated in the Paradigm CTF 2022 where I was personally able to solve 7 out of the 13 EVM-related challenges (not counting the PVP game 0xMonaco and external underhanded solidity contest). I made a few 0xMonaco cars as well, but at the end we went with the car my teammates made since I was only able to work on mine for a few hours. I did not attempt or look at any of the Cairo / Solana challenges as I felt that I would not be able to do so much in the provided 48h." /><meta property="og:description" content="Intro I participated in the Paradigm CTF 2022 where I was personally able to solve 7 out of the 13 EVM-related challenges (not counting the PVP game 0xMonaco and external underhanded solidity contest). I made a few 0xMonaco cars as well, but at the end we went with the car my teammates made since I was only able to work on mine for a few hours. I did not attempt or look at any of the Cairo / Solana challenges as I felt that I would not be able to do so much in the provided 48h." /><link rel="canonical" href="https://philogy.github.io/posts/paradigm-ctf-2022-write-up-collection/" /><meta property="og:url" content="https://philogy.github.io/posts/paradigm-ctf-2022-write-up-collection/" /><meta property="og:site_name" content="Philogy‚Äôs blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-08-22T12:36:00+02:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Paradigm CTF 2022: Write-Up Collection" /><meta name="twitter:site" content="@real_philogy" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-01-18T16:04:58+01:00","datePublished":"2022-08-22T12:36:00+02:00","description":"Intro I participated in the Paradigm CTF 2022 where I was personally able to solve 7 out of the 13 EVM-related challenges (not counting the PVP game 0xMonaco and external underhanded solidity contest). I made a few 0xMonaco cars as well, but at the end we went with the car my teammates made since I was only able to work on mine for a few hours. I did not attempt or look at any of the Cairo / Solana challenges as I felt that I would not be able to do so much in the provided 48h.","headline":"Paradigm CTF 2022: Write-Up Collection","mainEntityOfPage":{"@type":"WebPage","@id":"https://philogy.github.io/posts/paradigm-ctf-2022-write-up-collection/"},"url":"https://philogy.github.io/posts/paradigm-ctf-2022-write-up-collection/"}</script><title>Paradigm CTF 2022: Write-Up Collection | Philogy's blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Philogy's blog"><meta name="application-name" content="Philogy's blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="stylesheet" href="/assets/lib/fonts/main.css"><link rel="stylesheet" href="/assets/lib/bootstrap-4.6.1/bootstrap.min.css"><link rel="stylesheet" href="/assets/lib/fontawesome-free-5.15.4/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.css"><link rel="stylesheet" href="/assets/lib/magnific-popup-1.1.0/magnific-popup.css"> <script src="/assets/lib/jquery-3.6.0/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" class="mx-auto"> <img src="/assets/headshot.jpeg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Philogy's blog</a></div><div class="site-subtitle font-italic">Phil's ideas & research.</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/Philogy" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/real_philogy" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['philippe','dumo.net'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a></div></div><div id="topbar-wrapper"><div id="topbar" class="container d-flex align-items-center justify-content-between h-100 pl-3 pr-3 pl-md-4 pr-md-4"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Paradigm CTF 2022: Write-Up Collection</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper" class="d-flex justify-content-center"><div id="main" class="container pl-xl-4 pr-xl-4"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-9 pr-xl-4"><div class="post pl-1 pr-1 pl-md-2 pr-md-2"><h1 data-toc-skip>Paradigm CTF 2022: Write-Up Collection</h1><div class="post-meta text-muted"> <span> Posted <em class="" data-ts="1661164560" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Aug 22, 2022 </em> </span> <span> Updated <em class="" data-ts="1705590298" data-df="ll" data-toggle="tooltip" data-placement="bottom"> Jan 18, 2024 </em> </span><div class="d-flex justify-content-between"> <span> By <em> <a href="/about">Philippe Dumonet</a> </em> </span><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3517 words"> <em>19 min</em> read</span></div></div></div><div class="post-content"><h2 id="intro"><span class="mr-2">Intro</span><a href="#intro" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>I participated in the Paradigm CTF 2022 where I was personally able to solve 7 out of the 13 EVM-related challenges (not counting the PVP game 0xMonaco and external underhanded solidity contest). I made a few 0xMonaco cars as well, but at the end we went with the car my teammates made since I was only able to work on mine for a few hours. I did not attempt or look at any of the Cairo / Solana challenges as I felt that I would not be able to do so much in the provided 48h.</p><p>Shout out to my team the <a href="https://twitter.com/notfellows">notfellows</a>! üòÑ</p><h3 id="intro---general-evm-challenge-structure"><span class="mr-2">Intro - General EVM Challenge Structure</span><a href="#intro---general-evm-challenge-structure" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>For the 13 EVM related challenges (not counting 0xMonaco, underhanded 2022) the goal was to get the <code class="language-plaintext highlighter-rouge">Setup</code> contract‚Äôs <code class="language-plaintext highlighter-rouge">isSolved</code> method to return <code class="language-plaintext highlighter-rouge">true</code> so that the flag could be retrieved from the server. The contracts were deployed to a private chain which was forked off of mainnet. This is an important detail as not all contracts were provided by the CTF, some were just the mainnet contracts which you then had to look at on etherscan.</p><h3 id="intro---write-up-locations"><span class="mr-2">Intro - Write-up Locations</span><a href="#intro---write-up-locations" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>This post contains technical write-ups of the <a href="/posts/paradigm-ctf-2022-write-up-collection/#hint-finance-">Hint Finance</a> and <a href="/posts/paradigm-ctf-2022-write-up-collection/#just-in-time-jit-">Just In Time</a> challenges.</p><p>Check out the <a href="/posts/paradigm-ctf-2022-write-up-collection/#glossary">Glossary</a> for links to write-ups of other challenges.</p><h2 id="hint-finance-"><span class="mr-2">Hint Finance üö©</span><a href="#hint-finance-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><blockquote><p>‚ÄúEarn rewards without risk by depositing tokens into one of HintFinance‚Äôs vaults!‚Äù</p><p>‚Äì Hint Finance Challenge Description</p></blockquote><p>The famous last words of many projects.</p><h3 id="hint-finance---intro"><span class="mr-2">Hint Finance - Intro</span><a href="#hint-finance---intro" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In case you‚Äôre just looking for the code here‚Äôs the <a href="https://gist.github.com/Philogy/61534359bbdccb016ebf86b21a0cb8a6"><strong>full script</strong></a> in foundry.</p><p>In the Hint Finance challenge the goal was to drain 3 identical vault contracts of at least 99% of their underlying token. While the vaults were identical, the tokens stored in the vaults were different.</p><p>The vault contract was set up as a typical reward contract whereby you deposit some amount of tokens X in return for vault shares which can be redeemed for your tokens X again, along some rewards in several tokens Y. Besides the <code class="language-plaintext highlighter-rouge">deposit</code> and <code class="language-plaintext highlighter-rouge">withdraw</code> methods the contracts also had a <code class="language-plaintext highlighter-rouge">flashloan</code> method allowing you to borrow any token the vault holds.</p><p>There were also a couple of methods related to rewards but I quickly realized that those were just distractions as you have no way of setting the reward tokens and all the configured reward tokens were not the actual target tokens you‚Äôre looking to drain</p><h3 id="hint-finance---initial-ideas-"><span class="mr-2">Hint Finance - Initial Ideas ü§î</span><a href="#hint-finance---initial-ideas-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Initially I looked at the flashloan method trying to find a way to deposit/withdraw during the loan but due to its design I had to conclude that this was not possible. This is because the flashloan method enforces not only that the tokens be returned but also that the amount of total outstanding vault shares remain constant. This means you can‚Äôt keep new shares, have existing shares be redeemed or otherwise mess with the share price besides increasing it by returning more tokens than necessary.</p><h3 id="hint-finance---erc777-does-it-again-"><span class="mr-2">Hint Finance - ERC777 Does It Again üò¨</span><a href="#hint-finance---erc777-does-it-again-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After my initial look I remembered that the contracts are forked off mainnet and decided to check their code. There I discovered that 2 of the 3 target tokens were ERC777 tokens.</p><blockquote class="prompt-tip"><div><p>ERC777 tokens are token contracts which are backwards compatible with ERC20 but implement added functionality based on the <a href="https://eips.ethereum.org/EIPS/eip-777">ERC777 standard</a>. Most importantly the standard specifies that a token‚Äôs <code class="language-plaintext highlighter-rouge">transfer</code> / <code class="language-plaintext highlighter-rouge">transferFrom</code> methods must function as follows (excluding allowance logic):</p><ol><li>Call the sender‚Äôs pre-transfer hook if one is registered<li>Change balance of sender, reciepient<li>Call the sender‚Äôs post-transfer hook if one is registered</ol></div></blockquote><p>Upon discovering that the 2 tokens were ERC777 tokens I went to check the obvious vulnerability that came to mind, thinking ‚Äúsurely it couldn‚Äôt be this straight forward‚Äù. I looked at the <code class="language-plaintext highlighter-rouge">withdraw</code> and <code class="language-plaintext highlighter-rouge">deposit</code> methods and checked whether I could leverage the pre-/post-transfer hooks to somehow exploit the vault:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">deposit</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">amount</span><span class="p">)</span>
    <span class="k">external</span>
    <span class="n">updateReward</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span>
    <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">ERC20Like</span><span class="p">(</span><span class="n">underlyingToken</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="kt">uint256</span> <span class="n">shares</span> <span class="o">=</span> <span class="n">totalSupply</span> <span class="o">==</span> <span class="mi">0</span>
        <span class="o">?</span> <span class="n">amount</span>
        <span class="o">:</span> <span class="p">(</span><span class="n">amount</span> <span class="o">*</span> <span class="n">totalSupply</span><span class="p">)</span> <span class="o">/</span> <span class="n">bal</span><span class="p">;</span>
    <span class="n">ERC20Like</span><span class="p">(</span><span class="n">underlyingToken</span><span class="p">).</span><span class="n">transferFrom</span><span class="p">(</span>
        <span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span>
        <span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">),</span>
        <span class="n">amount</span>
    <span class="p">);</span>
    <span class="n">totalSupply</span> <span class="o">+=</span> <span class="n">shares</span><span class="p">;</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">+=</span> <span class="n">shares</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">shares</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">withdraw</span><span class="p">(</span><span class="kt">uint256</span> <span class="n">shares</span><span class="p">)</span>
    <span class="k">external</span>
    <span class="n">updateReward</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span>
    <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">bal</span> <span class="o">=</span> <span class="n">ERC20Like</span><span class="p">(</span><span class="n">underlyingToken</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="kt">uint256</span> <span class="n">amount</span> <span class="o">=</span> <span class="p">(</span><span class="n">shares</span> <span class="o">*</span> <span class="n">bal</span><span class="p">)</span> <span class="o">/</span> <span class="n">totalSupply</span><span class="p">;</span>
    <span class="n">ERC20Like</span><span class="p">(</span><span class="n">underlyingToken</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="n">totalSupply</span> <span class="o">-=</span> <span class="n">shares</span><span class="p">;</span>
    <span class="n">balanceOf</span><span class="p">[</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">]</span> <span class="o">-=</span> <span class="n">shares</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">amount</span><span class="p">;</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Looking at the <code class="language-plaintext highlighter-rouge">deposit</code> method you only get control via the pre-transfer hook. This is not useful as the logic for updating the token balance and issuing new shares happens after the hook is complete, oustside of your control.</p><p>The <code class="language-plaintext highlighter-rouge">withdraw</code> method is the jackpot however as you get the control-flow via the post-transfer hook, <strong>after</strong> the balance was changed but <strong>before</strong> your share balance is updated. Let‚Äôs break it down with an example where we withdraw everything to illustrate:</p><div class="table-wrapper"><table><thead><tr><th>Step<th>Vault Balance<th>Your Balance<th>Total Shares<th>Your Shares<th>Share Price<tbody><tr><td>Before <code class="language-plaintext highlighter-rouge">withdraw</code> call<td>100.00<td>0.0<td>100.0<td>50.0<td>1.0<tr><td><strong>Start of post-transfer hook</strong><td><strong>50.00</strong> (-50)<td><strong>50.0</strong> (+50)<td>100.0<td>50.0<td>0.5<tr><td>Contract reduces share balance<td>50.00<td>50.0<td>50.0 (-50)<td>0.0 (-50)<td>1.0<tr><td><strong>After call:</strong><td>50.00<td>50.0<td>50.0<td>0.0<td>1.0</table></div><p>As you‚Äôll notice there‚Äôs a temporary dip in share price at the point where we take over the control-flow. We can ‚Äúbuy the dip‚Äù we artificially create by depositing back into the vault:</p><div class="table-wrapper"><table><thead><tr><th>Step<th>Vault Balance<th>Your Balance<th>Total Shares<th>Your Shares<th>Share Price<tbody><tr><td>Before <code class="language-plaintext highlighter-rouge">withdraw</code> call<td>100.00<td>0.0<td>100.0<td>50.0<td>1.0<tr><td>Start of post-transfer hook<td><strong>50.00</strong> (-50)<td><strong>50.0</strong> (+50)<td>100.0<td>50.0<td>0.5<tr><td>After buying shares <code class="language-plaintext highlighter-rouge">deposit(50.0)</code><td><strong>100.00</strong> (+50)<td>0.0 (-50)<td><strong>200.0</strong> (+100)<td><strong>150.0</strong> (+100)<td>0.5<tr><td>Contract reduces share balance<td>100.0<td>0.0<td><strong>150.0</strong> (-50)<td><strong>100.0</strong> (-50)<td>0.667<tr><td><strong>After call:</strong><td>100.0<td>0.0<td>150.0<td>100.0<td><strong>0.667</strong></table></div><p>Result is we were able to mint shares ‚Äúout of thin air‚Äù, diluting the other depositors and allowing us to redeem more tokens. If we repeat this a couple times we‚Äôll eventually own 99%+ of the shares and be able to drain the 2 ERC777 (PNT, AMP) tokens from the vault.</p><p>I‚Äôm not going to detail the implementation of a ERC777 based reentrancy attack, as it‚Äôs a fairly common thing but you can view my exploit script <a href="https://gist.github.com/Philogy/61534359bbdccb016ebf86b21a0cb8a6">here</a> if you‚Äôre interested in the implementation details.</p><h3 id="hint-finance---the-final-token-how-"><span class="mr-2">Hint Finance - The Final Token, How????!!! üò°</span><a href="#hint-finance---the-final-token-how-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>After the first 2 tokens were relatively straight forward I started wondering how I was gonna approach the last one, SAND (ID: 1). Its transfer methods had no strange hooks, the contract file names didn‚Äôt seem to advertise any unusual standards being implemented so what can I do?</p><p>Well I went back to the vault contract and made an inventory of all the potential external calls I could somehow use:</p><ul class="task-list"><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" /><del><code class="language-plaintext highlighter-rouge">transferFrom</code> in <code class="language-plaintext highlighter-rouge">provideRewardTokens(...)</code> (only transfers rewards in)</del><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" /><del><code class="language-plaintext highlighter-rouge">transfer</code> in <code class="language-plaintext highlighter-rouge">getRewards(...)</code> (only transfers specific reward tokens out)</del><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" /><del><code class="language-plaintext highlighter-rouge">transferFrom</code> in <code class="language-plaintext highlighter-rouge">deposit(...)</code> (only transfers in tokens)</del><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" /><del><code class="language-plaintext highlighter-rouge">transfer</code> in <code class="language-plaintext highlighter-rouge">withdraw(...)</code> (transfers out but only exploitable with reentrancy)</del><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" /><del><code class="language-plaintext highlighter-rouge">transfer</code> in <code class="language-plaintext highlighter-rouge">flashloan(...)</code> (transfers out but cannot keep tokens)</del><li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" /><code class="language-plaintext highlighter-rouge">onHintFinanceFlashloan</code> in <code class="language-plaintext highlighter-rouge">flashloan(...)</code> (triggers flashloan callback)<li class="task-list-item" hide-bullet><input type="checkbox" class="task-list-item-checkbox" disabled="disabled" checked="checked" /><del>several <code class="language-plaintext highlighter-rouge">balanceOf</code> (view method, meaning staticcall used under the hood)</del></ul><p>Hmmm ü§î, there seems to be only two possibilities left: either I‚Äôm wrong about one of the other paths or the selector of the weirdly named <code class="language-plaintext highlighter-rouge">onHintFinanceFlashloan</code> method collides with another useful method. This is possible because the <a href="https://docs.soliditylang.org/en/develop/abi-spec.html#function-selector">ABI spec</a> says that selectors have to be the first 4-bytes of the function signature.</p><p>So I calculated the selector of <code class="language-plaintext highlighter-rouge">onHintFinanceFlashloan</code>, <code class="language-plaintext highlighter-rouge">0xcae9ca51</code> and put it in <a href="https://www.4byte.directory/signatures/?bytes4_signature=0xcae9ca51">4byte.directory</a>, a database of function signatures and their selectors. Note that when I looked at 4byte during the challenge <code class="language-plaintext highlighter-rouge">onHintFinanceFlashloan</code> was not yet uploaded.</p><p>I was right, not only is there an alternative function but it was already uploaded to 4byte (I could‚Äôve been searching much longer if I had to check it manually) and it was also present on the token contract: the <code class="language-plaintext highlighter-rouge">approveAndCall(...)</code> method! This is exactly what I needed, if you craft the call payload well the vault will simply approve some address you create to spend tokens on its behalf and the tokens will be mine ü§ë.</p><h3 id="hint-finance---flexible-abi"><span class="mr-2">Hint Finance - Flexible ABI</span><a href="#hint-finance---flexible-abi" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before doing a victory lapse we actually have to exploit this vulnerability which is not that trivial. Let‚Äôs look at the <code class="language-plaintext highlighter-rouge">flashloan</code> method as a whole:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="n">flashloan</span><span class="p">(</span>
    <span class="kt">address</span> <span class="n">token</span><span class="p">,</span>
    <span class="kt">uint256</span> <span class="n">amount</span><span class="p">,</span>
    <span class="kt">bytes</span> <span class="k">calldata</span> <span class="n">data</span>
<span class="p">)</span> <span class="k">external</span> <span class="n">updateReward</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="kt">uint256</span> <span class="n">supplyBefore</span> <span class="o">=</span> <span class="n">totalSupply</span><span class="p">;</span>
    <span class="kt">uint256</span> <span class="n">balBefore</span> <span class="o">=</span> <span class="n">ERC20Like</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="kt">bool</span> <span class="n">isUnderlyingOrReward</span> <span class="o">=</span> <span class="n">token</span> <span class="o">==</span> <span class="n">underlyingToken</span> <span class="o">||</span>
        <span class="n">rewardData</span><span class="p">[</span><span class="n">token</span><span class="p">].</span><span class="n">rewardsDuration</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">ERC20Like</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="nb">transfer</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span> <span class="n">amount</span><span class="p">);</span>
    <span class="n">IHintFinanceFlashloanReceiver</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">sender</span><span class="p">).</span><span class="n">onHintFinanceFlashloan</span><span class="p">(</span>
        <span class="n">token</span><span class="p">,</span>
        <span class="n">factory</span><span class="p">,</span>
        <span class="n">amount</span><span class="p">,</span>
        <span class="n">isUnderlyingOrReward</span><span class="p">,</span>
        <span class="n">data</span>
    <span class="p">);</span>

    <span class="kt">uint256</span> <span class="n">balAfter</span> <span class="o">=</span> <span class="n">ERC20Like</span><span class="p">(</span><span class="n">token</span><span class="p">).</span><span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="nb">this</span><span class="p">));</span>
    <span class="kt">uint256</span> <span class="n">supplyAfter</span> <span class="o">=</span> <span class="n">totalSupply</span><span class="p">;</span>

    <span class="nb">require</span><span class="p">(</span><span class="n">supplyBefore</span> <span class="o">==</span> <span class="n">supplyAfter</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">isUnderlyingOrReward</span><span class="p">)</span> <span class="p">{</span>
        <span class="kt">uint256</span> <span class="n">extra</span> <span class="o">=</span> <span class="n">balAfter</span> <span class="o">-</span> <span class="n">balBefore</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">extra</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">token</span> <span class="o">!=</span> <span class="n">underlyingToken</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">_updateRewardRate</span><span class="p">(</span><span class="n">token</span><span class="p">,</span> <span class="n">extra</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
        <span class="nb">require</span><span class="p">(</span><span class="n">balAfter</span> <span class="o">==</span> <span class="n">balBefore</span><span class="p">);</span> <span class="c1">// don't want random tokens to get stuck
</span>    <span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><p>The <code class="language-plaintext highlighter-rouge">flashloan</code> method calls the caller, not necessarily the token directly meaning we need the token to be the caller somehow and give the vault a specific payload. Thankfully we can just leverage <code class="language-plaintext highlighter-rouge">approveAndCall</code> again, approving the vault and calling the <code class="language-plaintext highlighter-rouge">flashloan</code> method.</p><p>There‚Äôs a few more tricky bits I had to find out while debugging my exploit as the two colliding methods have different parameters. Let‚Äôs breakdown the calldata that the vault creates when calling <code class="language-plaintext highlighter-rouge">onHintFinanceFlashloan</code>:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre>cae9ca51 // selector
0x00: &lt;32-byte padded address&gt; // vault: token, SAND: target
0x20: &lt;32-byte padded address&gt; // vault: factory, SAND: amount
0x40: &lt;32-byte uint&gt;  // vault: amount, SAND: data.offset
0x60: &lt;32-byte padded bool&gt; // vault: isUnderlyingOrReward, SAND: ?
0x80: &lt;32-byte padded byte-string offset (0xa0)&gt; // vault: data.offset, SAND: ?
0xa0: &lt;32-byte padded byte-string length&gt; // vault: data.length, SAND: ?
0xc0..X: &lt;byte-string&gt; // vault: data, SAND: ?
</pre></table></code></div></div><p>Firstly the recipient of the approval will be the <code class="language-plaintext highlighter-rouge">token</code>. This means that we can‚Äôt directly be the recipient of the approval because solidity will revert if you try to call methods like <code class="language-plaintext highlighter-rouge">balanceOf</code> or <code class="language-plaintext highlighter-rouge">transfer</code> on an EOA. So I created a custom contract to execute the exploit which had some methods so that it can pretend it‚Äôs an ERC20 token:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="k">function</span> <span class="nb">transfer</span><span class="p">(</span><span class="kt">address</span><span class="p">,</span> <span class="kt">uint256</span><span class="p">)</span> <span class="k">external</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">bool</span><span class="p">)</span> <span class="p">{</span>
	<span class="c1">// just needs to not revert
</span>	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">function</span> <span class="n">balanceOf</span><span class="p">(</span><span class="kt">address</span><span class="p">)</span> <span class="k">external</span> <span class="k">view</span> <span class="k">returns</span> <span class="p">(</span><span class="kt">uint256</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="mi">1e18</span><span class="p">;</span> <span class="c1">// constant for the sake of simplicity
</span><span class="p">}</span>
</pre></table></code></div></div><p>Next you‚Äôll notice that the approve amount that the token contract receives will be the address of the factory. Considering the token has 18 decimals and an address is about ~1e30 when interpreted as a number that‚Äôll be more than enough to drain the contract in one go.</p><p>A further aspect is that <code class="language-plaintext highlighter-rouge">amount</code> can‚Äôt be just anything. If it‚Äôs <code class="language-plaintext highlighter-rouge">0</code> and points at an address it‚Äôll imply such a large byte-string that <code class="language-plaintext highlighter-rouge">approveAndCall</code> will just revert when it tries to copy it from calldata to memory. Instead we set it to <code class="language-plaintext highlighter-rouge">0xa0</code> so that when <code class="language-plaintext highlighter-rouge">approveAndCall</code> tries to get the data it‚Äôll find the <code class="language-plaintext highlighter-rouge">data</code> provided by the vault.</p><p>Another error I got is <code class="language-plaintext highlighter-rouge">"first param != sender"</code> from the token contract, this is because the <code class="language-plaintext highlighter-rouge">approveAndCall</code> method enforces that the data has a minimum length and that the first argument is the caller‚Äôs address. To ensure the correct length and address I set the return payload of the nested call to <code class="language-plaintext highlighter-rouge">approveAndCall</code> to be:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kt">bytes</span> <span class="k">memory</span> <span class="n">innerPayload</span> <span class="o">=</span> <span class="n">abi</span><span class="p">.</span><span class="n">encodeWithSelector</span><span class="p">(</span>
	<span class="kt">bytes4</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">),</span>
	<span class="n">_sandVault</span><span class="p">,</span>
	<span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
	<span class="kt">bytes32</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">);</span>
</pre></table></code></div></div><p>The selector is <code class="language-plaintext highlighter-rouge">0x00000000</code> for simplicity so I add an empty fallback method to my exploit contract so it accepts the final call.</p><p>Finally I just nest the calls and use <code class="language-plaintext highlighter-rouge">transferFrom</code> to transfer the tokens out of the vault. You can view my full solution <a href="https://gist.github.com/Philogy/61534359bbdccb016ebf86b21a0cb8a6">here</a>.</p><h3 id="hint-finance---conclusion"><span class="mr-2">Hint Finance - Conclusion</span><a href="#hint-finance---conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>The Hint Finance challenge reminds us that we should always be wary of external calls to user controllable addresses and that you should always assume that ERC20 tokens can reenter upon transfers, just like ETH.</p><h2 id="just-in-time-jit-"><span class="mr-2">Just In Time (JIT) üö©</span><a href="#just-in-time-jit-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><h3 id="jit---intro"><span class="mr-2">JIT - Intro</span><a href="#jit---intro" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>In case you‚Äôre just looking for the code here‚Äôs the <a href="https://gist.github.com/Philogy/f4f48a29053344ce467c12ff62ebea8a"><strong>full script</strong></a> I wrote to solve the challenge. Considering that only 5 others solved it I am particularly proud of having solved this one. Especially since I really struggled with it:</p><p><img data-src="/assets/images/struggling-with-jit.png" alt="Message from me &quot;I spent half the day just staring at just-in-time sob emoji üòÇüò≠&quot;, Georgios Konstantopoulos responds &quot;lmao&quot;" data-proofer-ignore></p><p>But after an estimated ~16h of struggle my perceverance paid off and I managed to conquer the challenge!</p><p>In the Just-In-Time challenge (referred to as JIT for the remainder) the condition for receiving the flag, was draining the provided <code class="language-plaintext highlighter-rouge">JIT</code> contract of ETH. The <code class="language-plaintext highlighter-rouge">JIT</code> contract performs some logic around a provided input <code class="language-plaintext highlighter-rouge">program</code>, compiling it to EVM bytecode, subsequently deploying it and then delegate calling it.</p><blockquote class="prompt-tip"><div><p><strong><code class="language-plaintext highlighter-rouge">DELEGATECALL</code></strong></p><p>Unlike a normal call, when a contract delegate calls to another it gives it complete control allowing it to modify storage, emit events, call other contracts, transfer ETH and even self destruct on its behalf.</p><p>While useful for libraries, proxies and complex patterns like <a href="https://eips.ethereum.org/EIPS/eip-2535">ERC-2535 Diamonds</a>, it can open up a lot of attack surface.</p><p>For more details refer to <a href="https://www.evm.codes/#f4">evm.codes</a> or the <a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum Yellow Paper</a></p></div></blockquote><h3 id="jit---compiler-structure-"><span class="mr-2">JIT - Compiler Structure üß±</span><a href="#jit---compiler-structure-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>If we‚Äôre going to give this JIT compiler a program that‚Äôll compile to malicious code we‚Äôll have to first understand it. Skimming over the contract and reading the comments we can identify 6 modules / steps:</p><ol><li>Loop finder: Finds and matches square-brackets <code class="language-plaintext highlighter-rouge">[]</code><li>Block finder: Based on the loops splits the program into discrete ‚Äúblocks‚Äù that can be jumped to<li>Optimizer: Shortens repetitive / inefficient program segments<li>Code generator: Generates the main meat of the code, translating jit symbols into EVM bytecode and keeping track of where blocks start and end in the bytecode.<li>Label filler: Inserts the actual jump locations into the code.<li>Deployer: Inserts the code length into the constructor, deploys and executes the code</ol><p>Side note: Looking at the basic set of symbols <code class="language-plaintext highlighter-rouge">[],.+-&lt;&gt;</code>, the ‚Äújit language‚Äù seems to be a super set of <a href="https://en.wikipedia.org/wiki/Brainfuck">Brainfuck</a>, a minimalistic, turing complete language.</p><h3 id="jit---desired-code"><span class="mr-2">JIT - Desired Code</span><a href="#jit---desired-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Before we trick the compiler into generating malicious code we need to ask ourselves what that code should look like so that we know what we‚Äôre aiming for. There‚Äôs a relatively small set of opcodes that would allow us to transfer out ETH: <code class="language-plaintext highlighter-rouge">CREATE</code> , <code class="language-plaintext highlighter-rouge">CALL</code>, <code class="language-plaintext highlighter-rouge">CALLCODE</code>, <code class="language-plaintext highlighter-rouge">DELEGATECALL</code>, <code class="language-plaintext highlighter-rouge">CREATE2</code> and <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code>.</p><p>From all these operations <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code> seems to be the best candidate as it only consumes 1 stack element and automatically transfers all ETH, especially useful considering how constrained the compiler is. The precise recipient is irrelevant as our sole win condition is to drain the compiler, making our goal: <strong>have the code reach a <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code> opcode with at least 1 element on the stack</strong>.</p><h3 id="jit---getting-our-code-in-Ô∏è"><span class="mr-2">JIT - Getting Our Code In üï≥Ô∏è</span><a href="#jit---getting-our-code-in-Ô∏è" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Working backwards we can look at the code generator and see that the only opcodes it directly inserts are: <code class="language-plaintext highlighter-rouge">SWAP</code>s, <code class="language-plaintext highlighter-rouge">PUSH</code>s, <code class="language-plaintext highlighter-rouge">MLOAD</code>, <code class="language-plaintext highlighter-rouge">MSTORE</code>, <code class="language-plaintext highlighter-rouge">JUMPDEST</code>, <code class="language-plaintext highlighter-rouge">JUMP</code>, <code class="language-plaintext highlighter-rouge">JUMPI</code>, <code class="language-plaintext highlighter-rouge">ADD</code>, <code class="language-plaintext highlighter-rouge">SUB</code>, <code class="language-plaintext highlighter-rouge">CALLDATALOAD</code>, <code class="language-plaintext highlighter-rouge">DUP</code>s, <code class="language-plaintext highlighter-rouge">SHR</code> and <code class="language-plaintext highlighter-rouge">LOG0</code>.</p><p>However there is a single section that inserts user defined bytes into the final result. However with heavy restrictions. If the parser doesn‚Äôt recognize a byte in the program it‚Äôll insert it directly into the code, wrapped in invalid opcodes:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="c1">// jit.compile isn't actually provided in the challenge, I simply split the invoke method for testing
</span><span class="n">jit</span><span class="p">.</span><span class="n">compile</span><span class="p">(</span><span class="s">"+-</span><span class="se">\xff</span><span class="s">"</span><span class="p">);</span>
</pre></table></code></div></div><p>Results in:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>630000001c80600e6000396000f3 (constructor)
6000618000                   (contract header, sets up stack)
5b                           (JUMPDEST, block start)
80516001018152               ("+")
8051600190038152             ("-")
deadffbeef                   (0xff wrapped in invalid opcodes)
5b00                         (contract footer, JUMPDEST STOP)
</pre></table></code></div></div><p>This presents the major issue that whatever opcode we place in the middle is <strong>not reachable</strong>. It can‚Äôt be reached linearly because of the invalid opcodes in front and it can‚Äôt be jumped to because the EVM requires a <code class="language-plaintext highlighter-rouge">JUMPDEST</code> at the location where a jump (<code class="language-plaintext highlighter-rouge">JUMP</code> / <code class="language-plaintext highlighter-rouge">JUMPI</code>) lands, meaning we actually need to insert at least 2 bytes somehow: <code class="language-plaintext highlighter-rouge">5bff</code> (<code class="language-plaintext highlighter-rouge">JUMPDEST</code>, <code class="language-plaintext highlighter-rouge">SELFDESTRUCT</code>).</p><p>There are other compiler sections that insert custom bytes but only ever after <code class="language-plaintext highlighter-rouge">PUSH</code> opcodes meaning they aren‚Äôt interpreted as their opcodes but as data.</p><h3 id="jit---breaking-the-wrapper-Ô∏è"><span class="mr-2">JIT - Breaking The Wrapper ‚õèÔ∏è</span><a href="#jit---breaking-the-wrapper-Ô∏è" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Note that we can put <strong>any</strong> opcode in the wrapper as long as its byte value doesn‚Äôt overlap with one of the recognized jit symbols (<code class="language-plaintext highlighter-rouge">[],.&lt;&gt;+-RLAS0#</code>), we can even insert a <code class="language-plaintext highlighter-rouge">PUSH</code> opcode into the wrapper. What‚Äôs interesting about the <code class="language-plaintext highlighter-rouge">PUSH</code> opcode here is that it‚Äôs not an isolated opcode, the bytes following a <code class="language-plaintext highlighter-rouge">PUSH</code> get pushed on the stack, so they‚Äôre not interpreted as functional opcodes but data.</p><p>While this still doesn‚Äôt allows us to reach the code it does allow us to change the meaning of subsequent code. As an example imagine the following EVM code:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>INVALID INVALID [SELFDESTRUCT] INVALID INVALID PUSH2 0x5bff
  de      ad          ff         be      ef     61    5bff
</pre></table></code></div></div><p>Now, placing a <code class="language-plaintext highlighter-rouge">PUSH3</code> in the invalidity wrapper:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>INVALID INVALID PUSH3 0xbeef61 JUMPDEST SELFDESTRUCT
  de      ad     62     beef61    5b         ff
</pre></table></code></div></div><p>The bytes <code class="language-plaintext highlighter-rouge">5bff</code> that were previously treated as data to be pushed, are all of a sudden malicious code!</p><p>Note in the actual JIT compiler we use the <code class="language-plaintext highlighter-rouge">A</code> / <code class="language-plaintext highlighter-rouge">S</code> symbols to insert the 2-bytes, which also inserts added opcodes before its <code class="language-plaintext highlighter-rouge">PUSH2</code> which is why my final solution uses <code class="language-plaintext highlighter-rouge">PUSH5</code> (<code class="language-plaintext highlighter-rouge">0x64</code>).</p><h3 id="jit---reaching-the-wrapper"><span class="mr-2">JIT - Reaching The Wrapper</span><a href="#jit---reaching-the-wrapper" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>We‚Äôve figured out how to insert some malicious code but now we actually need to jump to it. Looking at the loop finder, block finder and label filler modules they seem quite robust, they only ever insert jump labels that jump between the edges of blocks, which are at the program‚Äôs square brackets.</p><p>Thankfully we can insert a custom jump location by leveraging 3 bugs in the compiler:</p><ol><li>The loop linking mapping <code class="language-plaintext highlighter-rouge">loops</code> is not reset between calls<li>The block to code position mapping <code class="language-plaintext highlighter-rouge">basicBlockAddrs</code> is also not reset between calls<li>Unmatched open-brackets <code class="language-plaintext highlighter-rouge">[</code> are allowed and do not reset their loop values</ol><p>Matched square brackets are safe because when they‚Äôre found their respective links are reset. However for unmatched square brackets the block finder still queries the <code class="language-plaintext highlighter-rouge">loops</code> mapping allowing us to use values set in previous calls.</p><h3 id="jit---tying-it-all-together-"><span class="mr-2">JIT - Tying It All Together üéÅ</span><a href="#jit---tying-it-all-together-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Now that we know how to exploit the contract we need to implement the exploit, while it‚Äôs relatively straight forward once you know how, getting the precise positions right is a bit finicky.</p><p>I started with the final program, inserting some padding <code class="language-plaintext highlighter-rouge">#</code> to ensure that I had enough space to set the necessary values in prior calls: <code class="language-plaintext highlighter-rouge">[################\x64S\x5b\xff</code>. I then compiled with JIT to see where the location of the critical <code class="language-plaintext highlighter-rouge">JUMPDEST</code> was. I then crafted 2 pieces of JIT code one setting the value in the <code class="language-plaintext highlighter-rouge">basicBlockAddrs</code> mapping and the other in <code class="language-plaintext highlighter-rouge">loops</code>. It‚Äôs likely possible to do it in 1 instead of 2 pre-solution programs but for simplicity‚Äôs sake I just did it in 2 as it was easier.</p><p>Despite all the effort the above work condenses down to the following small solution:</p><div class="language-solidity highlighter-rouge"><div class="code-header"> <span data-label-text="Solidity"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="c1">// SPDX-License-Identifier: GPL-3.0-only
</span>
<span class="k">pragma</span> <span class="n">solidity</span> <span class="o">^</span><span class="mf">0.8</span><span class="p">.</span><span class="mi">13</span><span class="p">;</span>

<span class="k">import</span> <span class="s">"forge-std/Script.sol"</span><span class="p">;</span>

<span class="k">import</span> <span class="p">{</span><span class="n">Setup</span><span class="p">,</span> <span class="n">JIT</span><span class="p">}</span> <span class="n">from</span> <span class="s">"src/public/contracts/Setup.sol"</span><span class="p">;</span>

<span class="k">contract</span> <span class="n">ExploitJIT</span> <span class="k">is</span> <span class="n">Script</span> <span class="p">{</span>
	<span class="k">function</span> <span class="n">setUp</span><span class="p">()</span> <span class="k">public</span> <span class="p">{}</span>

	<span class="k">function</span> <span class="n">run</span><span class="p">()</span> <span class="k">public</span> <span class="p">{</span>
		<span class="n">vm</span><span class="p">.</span><span class="n">startBroadcast</span><span class="p">();</span>
		<span class="n">Setup</span> <span class="n">s</span> <span class="o">=</span> <span class="n">Setup</span><span class="p">(</span><span class="n">vm</span><span class="p">.</span><span class="n">envAddress</span><span class="p">(</span><span class="s">"SETUP_ADDR"</span><span class="p">));</span>
		<span class="n">JIT</span> <span class="n">jit</span> <span class="o">=</span> <span class="n">s</span><span class="p">.</span><span class="n">TARGET</span><span class="p">();</span>

		<span class="n">jit</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="s">"[#######################]"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
		<span class="n">jit</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="s">"########################[]"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>
		<span class="n">jit</span><span class="p">.</span><span class="n">invoke</span><span class="p">(</span><span class="s">"[################</span><span class="se">\x64</span><span class="s">S[</span><span class="se">\xff</span><span class="s">"</span><span class="p">,</span> <span class="s">""</span><span class="p">);</span>

		<span class="n">vm</span><span class="p">.</span><span class="n">stopBroadcast</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>
</pre></table></code></div></div><h3 id="jit---conclusion"><span class="mr-2">JIT - Conclusion</span><a href="#jit---conclusion" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3><p>Just-In-Time shows us that simplicity is king and that you should avoid using storage mappings for on the fly calculations. Not only is it vulnerable but it costs a lot of gas!</p><p>This challenge also taught me that I should never give up and always look for stupid stuff I missed. I was stuck for several hours because I missed the fact that <code class="language-plaintext highlighter-rouge">JIT</code> used mappings for certain critical data structures and didn‚Äôt take precautions to reset them in-between calls. Making a detailed list of assumptions I had and checking them could‚Äôve helped me discover this sooner.</p><h2 id="glossary"><span class="mr-2">Glossary</span><a href="#glossary" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2><p>The following is a breakdown of the Paradigm CTF 2022 with links to respsective write-ups. Challenges are sorted by total solves. Credit to <a href="https://twitter.com/0xfoobar/status/1561529252029276161">0xfoobar‚Äôs thread</a> for links to some of the write-ups.</p><ul><li>‚úÖ Means personally solved (for 0xMonaco just means participated)<li>‚ùå Did not solve</ul><p><strong>EVM (Solidity) Challenges:</strong></p><ul><li>‚úÖ 0xMonaco (<a href="https://twitter.com/abdulsamijay/status/1561821616778141696">meta thread</a>, <a href="https://twitter.com/z0age/status/1561685707650990084">winning car by 0age</a>, <a href="https://twitter.com/sudolabel/status/1561512456291172352">thread 1</a>)<li>‚ùå Solidity Underhanded 2022<li>‚ùå Fun Reversing Challenge<li>‚ùå <a href="https://hackmd.io/@theori/r1gnaGNks#Stealing-Sats">Stealing Sats</a><li>‚ùå <a href="https://ventral.digital/posts/2022/8/22/paradigm-ctf-2022-electric-sheep">Electric Sheep</a><li>‚úÖ <a href="/posts/paradigm-ctf-2022-write-up-collection/#just-in-time-jit-">Just-in-Time</a><li>‚ùå Trapdoooor<li>‚úÖ <a href="/posts/paradigm-ctf-2022-write-up-collection/#hint-finance-">Hint Finance</a> üèÖ (I got first blood)<li>‚ùå <a href="https://twitter.com/elyx0/status/1561532604519747584">Trapdooor</a><li>‚ùå Lockbox 2 (<a href="https://twitter.com/brockjelmore/status/1561526932860153856">Stage 4 &amp; 5</a>)<li>‚úÖ <a href="https://twitter.com/danielvf/status/1561508004423471104">Vanity</a><li>‚úÖ Sourcecode<li>‚úÖ <a href="https://jeiwan.net/posts/my-paradigm-ctf-solutions/">Merkledrop</a><li>‚úÖ <a href="https://jeiwan.net/posts/my-paradigm-ctf-solutions/">Rescue</a><li>‚úÖ Random</ul><p><strong>Solana Challenges:</strong></p><ul><li>‚ùå <a href="https://twitter.com/raggedsec/status/1561514247783256064">Solhana 3</a><li>‚ùå <a href="https://twitter.com/raggedsec/status/1561514247783256064">Solhana 2</a><li>‚ùå <a href="https://twitter.com/raggedsec/status/1561514247783256064">Solhana 1</a><li>‚ùå <a href="https://twitter.com/NotDeGhost/status/1561545438897078273">Otter Swap</a><li>‚ùå <a href="https://twitter.com/NotDeGhost/status/1561545438897078273">Otter World</a></ul><p><strong>Cairo Challenges:</strong></p><ul><li>‚ùå Cairo Auction<li>‚ùå <a href="https://jeiwan.net/posts/my-paradigm-ctf-solutions/">Cairo Proxy</a><li>‚ùå Riddle Of The Sphinx</ul><p><br /> <br /></p><p>Found a grammar, spelling or factual error or would like to suggest an improvement? Feel free to raise an <a href="https://github.com/Philogy/philogy.github.io/issues">issue</a> or reach out to me on <a href="https://twitter.com/real_philogy">twitter</a>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/ctf-writeups/'>ctf-writeups</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/solidity/" class="post-tag no-text-decoration" >solidity</a> <a href="/tags/evm/" class="post-tag no-text-decoration" >EVM</a> <a href="/tags/security/" class="post-tag no-text-decoration" >security</a> <a href="/tags/smart-contracts/" class="post-tag no-text-decoration" >smart contracts</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Paradigm+CTF+2022%3A+Write-Up+Collection+-+Philogy%27s+blog&url=https%3A%2F%2Fphilogy.github.io%2Fposts%2Fparadigm-ctf-2022-write-up-collection%2F" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://t.me/share/url?url=https%3A%2F%2Fphilogy.github.io%2Fposts%2Fparadigm-ctf-2022-write-up-collection%2F&text=Paradigm+CTF+2022%3A+Write-Up+Collection+-+Philogy%27s+blog" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/curta-zsafe-writeup/">Curta CTF ZSafe Write-up</a><li><a href="/posts/paradigm-ctf-2022-write-up-collection/">Paradigm CTF 2022: Write-Up Collection</a><li><a href="/posts/quitting-dereg/">Quitting DeReg And What's Next</a><li><a href="/posts/defi-accounting-for-noobs/">Beancount: DeFi Accounting For Noobs</a><li><a href="/posts/selector-switches/">Constant Gas Function Dispatchers in the EVM</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/evm/">EVM</a> <a class="post-tag" href="/tags/smart-contracts/">smart contracts</a> <a class="post-tag" href="/tags/solidity/">solidity</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/accounting/">accounting</a> <a class="post-tag" href="/tags/beancount/">beancount</a> <a class="post-tag" href="/tags/defi/">DeFi</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/personal/">personal</a></div></div></div><script src="/assets/lib/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div id="tail-wrapper" class="col-12 col-lg-11 col-xl-9 pl-3 pr-3 pr-xl-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/curta-zsafe-writeup/"><div class="card-body"> <em class="small" data-ts="1705568820" data-df="ll" > Jan 18, 2024 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Curta CTF ZSafe Write-up</h3><div class="text-muted small"><p> This is a write-up for the Curta CTF ZSafe challenge. I initially didn‚Äôt submit a solution due to personal time constraints and issues with foundry scripts that made it impossible to submit directl...</p></div></div></a></div><div class="card"> <a href="/posts/selector-switches/"><div class="card-body"> <em class="small" data-ts="1647453300" data-df="ll" > Mar 16, 2022 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Constant Gas Function Dispatchers in the EVM</h3><div class="text-muted small"><p> Image: Telecom switchboard operator1 Intro Every2 smart contract on Ethereum and other EVM chains starts with its function dispatcher. Function dispatchers tell the contract whether they‚Äôve imple...</p></div></div></a></div><div class="card"> <a href="/posts/quitting-dereg/"><div class="card-body"> <em class="small" data-ts="1700845080" data-df="ll" > Nov 24, 2023 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Quitting DeReg And What's Next</h3><div class="text-muted small"><p> Introduction For just over a year now I‚Äôve been working on a startup called ‚ÄúDeReg‚Äù, mostly full-time together with my amazing brother &amp;amp; co-founder Dimitri. Recently we have decided to stop th...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/selector-switches/" class="btn btn-outline-primary" prompt="Older"><p>Constant Gas Function Dispatchers in the EVM</p></a> <a href="/posts/defi-accounting-for-noobs/" class="btn btn-outline-primary" prompt="Newer"><p>Beancount: DeFi Accounting For Noobs</p></a></div></div></div><footer class="pl-3 pr-3"><div class="row d-flex justify-content-between align-items-center text-muted pl-0 pr-0"><div class="col-6 footer-left width-full"><p class="mb-0"> ¬© 2026 <a href="/about">Philippe Dumonet</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="col-6 footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/evm/">EVM</a> <a class="post-tag" href="/tags/smart-contracts/">smart contracts</a> <a class="post-tag" href="/tags/solidity/">solidity</a> <a class="post-tag" href="/tags/security/">security</a> <a class="post-tag" href="/tags/accounting/">accounting</a> <a class="post-tag" href="/tags/beancount/">beancount</a> <a class="post-tag" href="/tags/defi/">DeFi</a> <a class="post-tag" href="/tags/development/">development</a> <a class="post-tag" href="/tags/personal/">personal</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a><div id="notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-animation="true" data-autohide="false"><div class="toast-header"> <button type="button" class="ml-2 ml-auto close" data-dismiss="toast" aria-label="Close"> <span aria-hidden="true">&times;</span> </button></div><div class="toast-body text-center pt-0"><p class="pl-2 pr-2 mb-3">A new version of content is available.</p><button type="button" class="btn btn-primary" aria-label="Update"> Update </button></div></div><script src="/assets/lib/simple-jekyll-search-1.10.0/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No results found.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="/assets/lib/magnific-popup-1.1.0/jquery.magnific-popup.min.js"></script> <script src="/assets/lib/lozad-1.16.0/lozad.min.js"></script> <script src="/assets/lib/clipboard-2.0.9/clipboard.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/dayjs.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/locale/en.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/plugin/relativeTime.min.js"></script> <script src="/assets/lib/dayjs-1.10.7/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="/assets/lib/bootstrap-4.6.1/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
